---
title: "Decision Processor (scotustext.R)"
author:
- name: Jake S. Truscott, Ph.D
  affiliation: University of Georgia
date: "`r Sys.Date()`"
output:
  html_document: 
    css: gray.css
---


```{=html}
<style type="text/css">
  body{
  font-size: 12pt;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(scotustext)
library(tidyverse)
library(tidytext)
library(tm)
library(plyr)
library(textdata)
library(dplyr)
library(purrr)
library(tidyr)
library(ggplot2)
library(data.table)
library(ggrepel)
library(lubridate)
library(strex)
library(utils)
library(anytime)
library(zoo)
library(rvest)
library(webshot)
library(htmltools)
library(pdftools)
library(stringr)
library(htm2txt)
library(sjPlot)
library(reactable)
library(reactablefmtr)
library(httr)
library(devtools)

decision_processor <- function(dir_path) {
  files <- list.files(dir_path, full.names = TRUE)
  num_files <- length(files)
  cat("\nDecisions to Process: ", num_files)
  all_decisions <- NULL

  start_time <- Sys.time()
  for (i in files) {
    cleaned_decisions <- suppressWarnings(decisions_cleaner(file_path = i, dir_path = i))
    all_decisions <- rbind(all_decisions, cleaned_decisions)
  }

  end_time <- Sys.time()
  elapsed_time <- end_time - start_time

  cat("\nSuccess!")
  cat("\n - - - - - - - Summary - - - - - - - ")
  cat("\nCompletion Time: ", round(as.numeric(elapsed_time), 2), "Seconds")
  cat("\nNumber of Unique Opinions: ", length(unique(all_decisions$argument)))
  cat("\nNumber of Majority Opinions: ", sum(all_decisions$opinion_type == "Majority Opinion"))
  cat("\nNumber of Dissents: ", sum(all_decisions$opinion_type == "Dissent"))
  cat("\nNumber of Concurrences: ", sum(all_decisions$opinion_type == "Concurrence"))
  cat("\nNumber of Per Curiam: ", sum(all_decisions$opinion_type == "Per Curiam"))

  return(all_decisions)
}

decision_processor_2 <- function(dir_path) {
  files <- list.files(dir_path, full.names = TRUE)
  num_files <- length(files)
  all_decisions <- NULL

  start_time <- Sys.time()
  for (i in files) {
    cleaned_decisions <- suppressWarnings(decisions_cleaner(file_path = i, dir_path = i))
    all_decisions <- rbind(all_decisions, cleaned_decisions)
  }

  end_time <- Sys.time()
  elapsed_time <- end_time - start_time

  return(all_decisions)
}

decisions_cleaner <- function(file_path, dir_path) {

  {
    rtext <- readtext::readtext(file_path)
    corpus <- Corpus(VectorSource(rtext$text))
    corpus <- tm_map(corpus, content_transformer(iconv), to = "ASCII//TRANSLIT")
    corpus <- tm_map(corpus, content_transformer(gsub), pattern = "on writ of certiorari", replacement = "<DECISION BREAK> on writ of certiorari", ignore.case = TRUE)
    corpus <- tm_map(corpus, content_transformer(gsub), pattern = "on petition for writ of certiorari", replacement = "<DECISION BREAK> on writ of certiorari", ignore.case = TRUE)
    corpus <- tm_map(corpus, content_transformer(gsub), pattern = "on writ of certiorari", replacement = "<DECISION BREAK> <KEEP>", ignore.case = TRUE)
    corpus <- tm_map(corpus, content_transformer(gsub), pattern = "on petition for writ of certiorari", replacement = "<DECISION BREAK> <KEEP>", ignore.case = TRUE)
    corpus <- tm_map(corpus, content_transformer(gsub), pattern = "certiorari to the (United States|Court|Supreme)", replacement = "<DECISION BREAK> <KEEP>", ignore.case = TRUE)
    corpus <- tm_map(corpus, content_transformer(gsub), pattern = "appeal from the united states district court", replacement = "<DECISION BREAK> <KEEP>", ignore.case = TRUE)
    corpus <- tm_map(corpus, content_transformer(gsub), pattern = "on bill of complaint", replacement = "<DECISION BREAK> <KEEP>", ignore.case = TRUE)
    decisions <- data.frame(text = sapply(corpus, as.character), stringsAsFactors = FALSE)
  } #Collect and Pre-Process Text
  {
    file_names_processed <- gsub(paste0(dir_path, "/"), "", file_path)
    file_names_processed <- gsub("\\_.*", "", file_names_processed)
    file_names_processed <- gsub(".pdf", "", file_names_processed)
    decisions$argument <- file_names_processed

    case_names <- c()

    for (pdf_file in file_path) {
      pdf_metadata <- pdf_info(pdf_file)
      title <- pdf_metadata$keys$Title
      case_names <- c(case_names, title)
    }

    case_names <- data.frame(case_names)
    case_names$docket_number <- sapply(case_names$case_names, function(x) {
      if (grepl(" ", x)) {
        return(sub(" .*", "", x))
      } else {
        return(NA)
      }
    })
    case_names$published <- sapply(case_names$case_names, function(x) {
      if (grepl("\\(", x)) {
        x <- sub(".*\\(|\\).*", "", x)
        x <- paste0("(", x)
        return(x)
      } else {
        return(NA)
      }
    })

    case_names$case_names <- mapply(function(case_name, published, docket_number) {
      if (!is.na(published)) {
        case_name <- gsub(published, "", case_name, fixed = TRUE)
      }
      if (!is.na(docket_number)) {
        case_name <- gsub(docket_number, "", case_name, fixed = TRUE)
      }
      return(case_name)
    }, case_names$case_names, case_names$published, case_names$docket_number)

    decisions$argument <- case_names$case_names
    decisions$docket_id <- case_names$docket_number
    decisions$published <- case_names$published


  } #File Metadata
  {
    decisions_test <- decisions %>%
      mutate(text = str_split(text, "\\<DECISION BREAK\\>")) %>%
      unnest(text) %>%
      filter(grepl("\\<Keep\\>", text, ignore.case = TRUE)) %>%
      filter(!grepl("syllabus\\n\\n", text, ignore.case = TRUE)) %>%
      mutate(text = trimws(text)) %>%
      mutate(text = gsub("\\n\\n", " \n\n ", text, perl = TRUE)) %>%
      mutate(text = gsub("\\n\\n ------\\n[ ]*", "<BEGIN FOOTNOTE> ", text)) %>%
      mutate(text = gsub("\\n------\\n", " \n------\n ", text, perl = TRUE)) %>%
      mutate(text = gsub("\\n------\\n", " <BEGIN FOOTNOTE> ", text, perl = TRUE)) %>%
      mutate(text = str_replace_all(text, "J., dissenting\\s+\\n\\n", "J., dissenting \n\n <END HEADER> ")) %>%
      mutate(text = str_replace_all(text, "J., concurring\\s+\\n\\n", "J., dissenting \n\n <END HEADER> ")) %>%
      mutate(text = str_replace_all(text, "Opinion of the Court\\s+\\n\\n", "J., dissenting \n\n <END HEADER> ")) %>%
      mutate(text = str_replace_all(text, "\\n\\n\\s+\\d+", "<BEGIN HEADER>")) %>%
      mutate(text = str_replace_all(text, "Cite as:", " <BEGIN HEADER> Cite as:"))  %>%
      mutate(footnotes = text) %>%
      mutate(footnotes = str_extract_all(text, "(?<=<BEGIN FOOTNOTE>)([\\s\\S]*?)(?=<BEGIN HEADER>)")) %>%
      mutate(footnotes = sapply(footnotes, function(x) if (length(x) > 0) paste(x, collapse = "\n\n") else NA_character_)) %>%
      mutate(text = gsub("<BEGIN FOOTNOTE>.*?<END HEADER>", "", text)) %>%
      mutate(text = gsub("<BEGIN HEADER>.*?<END HEADER>", "", text)) %>%
      mutate(footnotes = gsub("\\n\\n {3,}(\\d+)", "<FOOTNOTE BREAK> \\1", footnotes)) %>%
      mutate(footnotes = gsub("\\n\\n", "", footnotes)) %>%
      mutate(footnotes = gsub("<FOOTNOTE BREAK>", "\n\n", footnotes)) %>%
      mutate(footnotes = gsub("\\-  ", "", footnotes)) %>%
      mutate(footnotes = gsub("\\- ", "", footnotes)) %>%
      mutate(footnotes = gsub("\\n", " ", footnotes)) %>%
      mutate(footnotes = gsub("  (\\d+)", "\n\n\\1", footnotes)) %>%
      mutate(footnotes = gsub("(?<![A-Za-z0-9\\n])\\s{5,}(?![A-Za-z0-9\\n])", " ", footnotes, perl = TRUE)) %>%
      mutate(footnotes = gsub("^\\s+", "", footnotes)) %>%
      mutate(footnotes = gsub("(?<=\\n)(\\d+)", "[\\1]", footnotes, perl = TRUE)) %>%
      mutate(footnotes = gsub("\\n\\n(?=\\[\\d{4,}\\])", "", footnotes, perl = TRUE)) %>%
      mutate(footnotes = str_replace(footnotes, "^(\\d+)", "[\\1]")) %>%
      mutate(footnotes = gsub("\\- ", "", footnotes)) %>%
      mutate(text = gsub("\\n(?=\\d)", " [", text, perl = TRUE)) %>%
      mutate(text = gsub("\\s(?=\\d)", "] ", text, perl = TRUE)) %>%
      mutate(text = gsub("\\s(?=\\n)", "] ", text, perl = TRUE)) %>%
      mutate(text = gsub("\\[(?=\\d)", "", text, perl = TRUE)) %>%
      mutate(text = gsub("\\](?=\\n)", "", text, perl = TRUE)) %>%
      mutate(text = gsub("\\](?=\\s)", "", text, perl = TRUE)) %>%
      mutate(opinion = sub("\\.(.*)", "", text)) %>%
      mutate(opinion = sub("\\.(.*)", "", text)) %>%
      mutate(opinion = trimws(opinion) %>%
               paste0(".")) %>%
      mutate(opinion_writer = str_extract_all(opinion, "(CHIEF JUSTICE|JUSTICE)\\s+(\\w+)") %>%
               sapply(paste, collapse = "; ") %>%
               sapply(function(x) gsub(" joins| join", "", x))) %>%
      mutate(opinion_type = case_when(
        grepl("delivered", opinion, ignore.case = T) & grepl("court", opinion, ignore.case = T) ~ "Majority Opinion",
        grepl("dissenting", opinion) ~ "Dissent",
        grepl("concurring", opinion) ~ "Concurrence",
        grepl("concurrence", opinion) & grepl("dissenting", opinion) & grepl("in part", opinion) ~ "Concur & Dissent (In Part)")) %>%
      mutate(opinion_type = ifelse(is.na(opinion_type), "Per Curiam", opinion_type))  %>%
      mutate(text = ifelse(opinion_type == "Per Curiam", gsub(".*PER CURIAM", "", text), text)) %>%
      mutate(opinion_writer = ifelse(opinion_type == "Per Curiam", "Per Curiam", opinion_writer)) %>%
      mutate(text = sub(".*?\\.", "", text)) %>%
      mutate(text = trimws(text)) %>%
      mutate(text = gsub("U\\.\\sS\\.\\sC\\.\\s\\?", "U. S. C. \u00A7", text)) %>%
      mutate(text = gsub("\\?(?=\\d)", "\u00A7", text, perl = T)) %>%
      mutate(text = gsub("\\s{2,}", " ", text)) %>%
      mutate(text = gsub("SUPREME COURT OF THE UNITED STATES.*", "", text)) %>%
      mutate(text = gsub("-\\n", "", text)) %>%
      mutate(text = gsub("\\n", " ", text)) %>%
      select(-c(opinion)) %>%
      select(argument, docket_id, published, text, footnotes, opinion_writer, opinion_type)
  } #Process & Clean Docket Frame

} #Process Opinions


```

```{r, eval = F}
#Load scotustext package
install.packages("scotustext")
library(scotustext)
```

## `decision_processor` **Overview** 

`decision_processer`serves as an automated tool for cleaning and parsing information from opinions at the United States Supreme Court. Implementation of the `decision_processor()` tool only requires a single parameter, `dir_path`, which provides a file path to the folder on your local machine containing opinions saved as PDFs. 

- `dir_path`: A character object denoting the relevant folder directory containing PDFs of Supreme Court decisions saved to your local machine    (e.g., `dir_path` = "C:/User/Name/Folder").

**NOTE**: `decision_processor()` should work for any non-scanned decision PDF and is not restricted term-specific conditions (e.g., the presence of particular justices, decisions, etc...). However, this tool does **not** employ the use of Optical Character Recognition (OCR) software. As such, the tool can only process **non-scanned** PDF opinions. Further, this tool is **not** capable of parsing US Reports Volumes. Functionality for these volumes will become available in future iterations of the package, though it should be capable of parsing opinions so long as any non-Opinion materials are removed from the Report volumes (e.g., preface, docket order, etc...)

## `decision_processor` **Variables** 

```{r, echo = F}
decisions_sample <- decision_processor_2(dir_path = "C:/Users/Jake Truscott/OneDrive - University of Georgia/Active/Justices Oral Argument Rhetoric/SCOTUS_Transcripts/decision_sample")
suppressMessages(names(decisions_sample))
```
- `argument`: Case name (e.g., *Becerra v. Empire Health Foundation, For Valley Hospital Medical Center*). 
- `docket_id`: Docket ID number assigned to the litigation by the Supreme Court (e.g., "19-1392").
- `published`: Date stamp assigned to the most recent version of the PDFs publishing on [supremecourt.gov](https://www.supremecourt.gov/docket/docket.aspx). 
- `text`: Opinion text (character string). 
- `footnotes`: Footnotes found in opinion text (if any). 
- `opinion_writer`: Denotes which justice authored the opinion of interest.    **NOTE**: Majority opinions denote a single justice as author, though concurrences and dissents will note any justices who joined the opinion (if any). However, the first justice listed is the primary author. 
- `opinion_type`: Factor type of decision published (**Majority Opinion**, **Concurrence**, **Dissent**, or **Per Curiam**. )

**NOTE**: `argument`, `docket_id`, and `published` are retrived using metadata stored within the individual PDFs. PDFs without accompanying metadata will return **NA** for these terms.  


## `decision_processor` **Examples** 

Below is an example of three decisions from the Court's 2021 and 2022 terms:  

-   *Twitter, Inc. v. Taamneh* (21-1496)
-   *Andy Warhol Foundation for Visual Arts, Inc. v. Goldsmith* (21-869)
-   *Dobbs v. Jackson Womenâ€™s Health Organization* (19-1392)

The processor will provide a completion report that includes summary statistics for the processed decisions: 

```{r, warning = F, eval = F}
#Replace <FOLDER DIRECTORY> with Relevant File Path
decisions_sample <- decision_processor(dir_path = <FOLDER DIRECTORY>)
```
```{r, echo = FALSE, warning = F, message = F, eval = T}
decisions_sample <- decision_processor(dir_path = "C:/Users/Jake Truscott/OneDrive - University of Georgia/Active/Justices Oral Argument Rhetoric/SCOTUS_Transcripts/decision_sample")
```

**Sample Text from Justice Kavanaugh's Concurrence in Dobbs v. Jackson Women's Health Clinic**
```{r, warning = F, echo = F}
filtered_data <- subset(decisions_sample, opinion_writer == "JUSTICE KAVANAUGH" & docket_id == "19-1392")
text_data <- filtered_data$text
words <- strsplit(text_data, "\\s+")
words <- c(words)
kavanaugh_words <- paste(words[[1]][1:200], collapse = " ")
cat(paste0(kavanaugh_words, "..."))
```

**Footnotes from Justice Sotomayor's Majority Opinion in *Andy Warhol Foundation for Visual Arts, Inc. v. Goldsmith* **
```{r, warning = F, echo = F}
sotomayor_footnotes <- subset(decisions_sample, opinion_writer == "JUSTICE SOTOMAYOR" & docket_id == "21-869")
cat(sotomayor_footnotes$footnotes)
```
