---
title: "Oral Arguments (scotustext.R)"
author:
- name: Jake S. Truscott, Ph.D
  affiliation: University of Georgia
date: "`r Sys.Date()`"
output:
  html_document:
    css: gray.css
---

```{=html}
<style type="text/css">
  body{
  font-size: 12pt;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(glue)
library(tidyverse)
library(tidytext)
library(tm)
library(plyr)
library(textdata)
library(dplyr)
library(purrr)
library(tidyr)
library(ggplot2)
library(data.table)
library(ggrepel)
library(lubridate)
library(strex)
library(utils)
library(anytime)
library(zoo)
library(rvest)
library(webshot)
library(htmltools)
library(pdftools)
library(stringr)
library(htm2txt)
library(sjPlot)
library(reactable)
library(reactablefmtr)
library(httr)
library(devtools)
oa_search <- function(term = NULL, justice = NULL, attorney = NULL, speaker_type = NULL, docket_id = NULL, party = NULL) {
  base_url <- "https://github.com/JakeTruscott/scotustext/raw/master/Data/"
  rdata_url <- paste0(base_url, "scotus_transcripts.rdata")
  load(url(rdata_url))

  if (!is.null(term)) {
    if (is.character(term)) {
      term <- list(term)
    }
    selection <- lapply(term, function(t) {
      scotus %>% filter(term == t)
    })
    scotus <- do.call(rbind, selection)
  }

  if (!is.null(docket_id)) {
    if (is.character(docket_id)) {
      docket_id <- list(docket_id)
    }
    selection <- lapply(docket_id, function(t) {
      scotus %>% filter(argument %in% t)
    })
    scotus <- do.call(rbind, selection)
  }

  if (!is.null(party)) {
    if (is.character(party)) {
      party <- list(party)
    }

    if (length(party) > 0) {
      party_short <- scotus$case_name
      party_short <- toupper(party_short)
      scotus$party_short <- party_short
      scotus <- scotus[grepl(toupper(party), party_short), ]

      if (nrow(scotus) > 0) {
        filtered_parties <- unique(scotus$case_name)
        filtered_parties <- filtered_parties[!is.na(filtered_parties)]
        #message("Oral Argument Data Filtered for:")
        #message(paste("Parties:", paste(filtered_parties, collapse = ", ")))
      }

      scotus$party_short <- NULL
    }
  }

  if (!is.null(speaker_type)) {
    if (is.character(speaker_type)) {
      speaker_type <- list(speaker_type)
    }
    selection <- lapply(speaker_type, function(t) {
      scotus %>% filter(type == t)
    })
    scotus <- do.call(rbind, selection)
  }

  if (!is.null(justice)) {
    justice_values <- toupper(justice)
    valid_speakers <- ifelse(grepl("roberts", justice, ignore.case = T), paste0("CHIEF JUSTICE ", justice), paste0("JUSTICE ", justice))

    justice_data <- scotus %>% filter(type == "Justice" & toupper(speaker) %in% toupper(valid_speakers))
    scotus <- justice_data
  }

  if (!is.null(attorney)) {
    if (is.character(attorney)) {
      attorney <- list(attorney)
    }

    if (length(attorney) > 0) {
      attorney_short <- gsub("(MR\\. |MS\\. |GENERAL\\. |GENERAL )", "", scotus$speaker)
      attorney_short <- toupper(attorney_short)
      scotus$attorney_short <- attorney_short
      scotus <- scotus[attorney_short %in% toupper(attorney), ]

      if (nrow(scotus) > 0) {
        filtered_attorneys <- unique(scotus$attorney_short)
        filtered_attorneys <- filtered_attorneys[!is.na(filtered_attorneys)]
        message("Oral Argument Data Filtered for:")
        message(paste("Attorneys:", paste(filtered_attorneys, collapse = ", ")))
      }

      # Remove the "attorney_short" column
      scotus$attorney_short <- NULL
    }
  }


  # Print the Filters

  collected_terms <- unique(scotus$term)
  if (length(collected_terms) > 0) {
    collected_terms <- sort(collected_terms)
    terms_string <- paste(collected_terms, collapse = ", ")
    message("Oral Argument Data Collected for...")
    message(paste("Terms:", terms_string))
  }

  if (!is.null(docket_id)) {
    collected_arguments <- unique(scotus$argument)
    if (length(collected_arguments) > 0) {
      collected_arguments <- sort(collected_arguments)
      arguments_string <- paste(collected_arguments, collapse = ", ")
      message(paste("Arguments:", arguments_string))
    }
  }

  if (!is.null(party)) {
    collected_cases <- unique(scotus$case_name)
    if (length(collected_cases) > 0) {
      collected_cases <- sort(collected_cases)
      cases_string <- paste(collected_cases, collapse = ", ")
      message(paste("Cases:", cases_string))
    }
  }

  collected_speaker_type <- unique(scotus$type)
  if (length(collected_speaker_type) > 0) {
    if ("Justice" %in% collected_speaker_type && "Attorney" %in% collected_speaker_type) {
      message("Speaker Type: Both Justices and Attorneys")
    } else if ("Justice" %in% collected_speaker_type) {
      message("Speaker Type: Justices ONLY")
    } else if ("Attorney" %in% collected_speaker_type) {
      message("Speaker Type: Attorneys Only")
    }
  }

  collected_justices <- unique(scotus$speaker)
  if (!is.null(justice)) {
    collected_justices <- unique(scotus$speaker)
    if (length(collected_justices) > 0) {
      collected_justices <- sort(collected_justices)
      justices_string <- paste(collected_justices, collapse = ", ")
      message(paste("Justices:", justices_string))
    }
  }

  return(scotus)
}
oa_parser <- function(dir_path = NULL) {
  cleaned_corpus <- suppressMessages({suppressWarnings(oa_corpus_cleaner(dir_path))})
  cleaned_frame <- suppressWarnings(oa_frame_cleaner(cleaned_corpus))
  message("\nCompletion Summary:\n")
  message(paste0("Total Arguments:", "  ", format(length(unique(cleaned_frame$argument)), big.mark = ","), "\n"))
  message(paste0("Total Statements:", "  ", format(length(cleaned_frame$text), big.mark = ","), "\n"))
  message(paste0("Number of Justices:", "  ", format(length(unique(cleaned_frame$speaker[cleaned_frame$speaker_type == "Justice" & cleaned_frame$speaker != "JUSTICE UNKNOWN"])), big.mark = ","), "\n"))
  message(paste0("Number of Unique Attorneys:", "  ", format(length(unique(cleaned_frame$speaker[cleaned_frame$speaker_type == "Attorney"])), big.mark = ","), "\n"))
  return(cleaned_frame)
}
oa_frame_cleaner <- function(cleaned_corpus){
  scotus <- cleaned_corpus %>%
    group_by(argument) %>%
    mutate(text = str_split(text, "(?=\\bCHIEF JUSTICE\\b|(?<!CHIEF )JUSTICE|MR\\.|MS\\.|GENERAL|QUESTION:)")) %>%
    unnest(text) %>%
    filter(!is.na(text)) %>%
    separate(text, c("justice", "text"), sep = ": ", extra = "merge") %>%
    mutate(text = gsub("::", ":", text)) %>%
    mutate(justice = gsub(":", "", justice)) %>%
    mutate(justice = trimws(justice)) %>%
    filter(!grepl("[^A-Za-z.' ]", justice)) %>%
    filter(!is.na(text)) %>%
    mutate(justice = trimws(justice)) %>%
    group_by(argument) %>%
    filter(grepl("JUSTICE|MR.|MS.|QUESTION:|GENERAL", justice, ignore.case = F)) %>%
    dplyr::mutate(id = row_number()) %>%
    mutate(text = gsub(" ORAL ARGUMENT OF.*","", text)) %>%
    mutate(text = gsub(" REBUTTAL ARGUMENT OF.*","", text)) %>%
    mutate(speaker_type = ifelse(grepl("JUSTICE", justice), "Justice", "Attorney")) %>%
    mutate(text = gsub("- Subject to Final Review", "", text, ignore.case = T)) %>%
    mutate(text = gsub(" Subject to Final Review", "", text, ignore.case = T)) %>%
    mutate(text = gsub("Alderson Reporting Company", "", text, ignore.case = T)) %>%
    mutate(case_name = ifelse(id == 1, text, NA)) %>%
    mutate(case_name = gsub(".*case|.*argument in|.*argument", "", case_name, ignore.case = T)) %>%
    mutate(case_name = gsub("^[^,]+,\\s*", "", case_name)) %>%
    mutate(case_name = ifelse(grepl("^ the\\s", case_name), sub("^ the\\s", "", case_name), case_name)) %>%
    mutate(case_name = ifelse(grepl("^the\\s", case_name), sub("^the\\s", "", case_name), case_name)) %>%
    mutate(case_name = gsub("\\. Mr.*|\\. Ms.*|\\. General.*", "", case_name, ignore.case = T )) %>%
    mutate(case_name = na.locf(case_name)) %>%
    mutate(case_name = gsub("versus|vs\\.", "v.", case_name)) %>%
    mutate(case_name = gsub("against", "v.", case_name)) %>%
    mutate(word_count = str_count(text, "\\w+")) %>%
    mutate(justice_fix = case_when(
      grepl("JUSTICE ROB", justice) & speaker_type == "Justice" ~ "CHIEF JUSTICE ROBERTS",
      grepl("JUSTICE GI", justice) & speaker_type == "Justice" ~ "JUSTICE GINSBURG",
      grepl("JUSTICE A", justice) & speaker_type == "Justice" ~ "JUSTICE ALITO",
      grepl("JUSTICE BR", justice) & speaker_type == "Justice" ~ "JUSTICE BREYER",
      grepl("JUSTICE KE", justice) & speaker_type == "Justice" ~ "JUSTICE KENNEDY",
      grepl("JUSTICE SC", justice) & speaker_type == "Justice" ~ "JUSTICE SCALIA",
      grepl("JUSTICE SOU", justice) & speaker_type == "Justice" ~ "JUSTICE SOUTER",
      grepl("JUSTICE ST", justice) & speaker_type == "Justice" ~ "JUSTICE STEVENS",
      grepl("JUSTICE SOT", justice) & speaker_type == "Justice" ~ "JUSTICE SOTOMAYOR",
      grepl("JUSTICE KAG", justice) & speaker_type == "Justice" ~ "JUSTICE KAGAN",
      grepl("JUSTICE T", justice) & speaker_type == "Justice" ~ "JUSTICE THOMAS",
      grepl("JUSTICE BA", justice) & speaker_type == "Justice" ~ "JUSTICE BARRETT",
      grepl("JUSTICE J", justice) & speaker_type == "Justice" ~ "JUSTICE JACKSON",
      grepl("JUSTICE KAV", justice) & speaker_type == "Justice" ~ "JUSTICE KAVANAUGH",
      grepl("JUSTICE GO", justice) & speaker_type == "Justice" ~ "JUSTICE GORSUCH"
    )) %>%
    mutate(justice = ifelse(is.na(justice_fix), justice, justice_fix)) %>%
    mutate(justice = ifelse(justice == "JUSTICE" & speaker_type == "Justice", "JUSTICE UNKNOWN", justice)) %>%
    mutate(justice = ifelse(justice == "CHIEF JUSTICE" & speaker_type == "Justice", "CHIEF JUSTICE ROBERTS", justice)) %>%
    mutate(justice = ifelse(justice == "JUSTICE PHILLIPS" & speaker_type == "Justice", "JUSTICE KENNEDY", justice)) %>%
    select(-c(justice_fix)) %>%
    mutate(justice = gsub(".*ON BEHALF", "", justice, ignore.case = T)) %>%
    mutate(text = gsub("Alderson Court Reporting 1", "", text)) %>%
    mutate(text = gsub("Alderson Court Reporting", "", text)) %>%
    mutate(speaker = justice) %>%
    select(speaker, text, argument, id, speaker_type, case_name, word_count)


  return(scotus)
}
oa_corpus_cleaner <- function(dir_path) {
  directory <- trimws(dir_path)
  file_directory <- paste0(directory, "/")

  file_names <- list.files(file_directory)
  total_files <- length(file_names)
  cat("Total Number of Transcripts to be Processed: ", format(total_files, big.mark = ","), "\n")

  dir_path <- trimws(dir_path)
  dir_path <- paste0(dir_path, "/*")
  rtext <- readtext::readtext(dir_path)
  corpus <- Corpus(VectorSource(rtext$text))

  patterns <- c("\\s\\b\\d+\\b\\s", "\n", "Heritage Reporting Corporation",
                "C O N T E N T S", "P R O C E E D I N G S", "Official ORAL ARGUMENT",
                "Official", "PAGE")
  replacements <- c(" ", "", "", "", "", "", "", "")

  for (i in seq_along(patterns)) {
    corpus <- tm_map(corpus, content_transformer(gsub), pattern = patterns[i], replacement = replacements[i])
  }

  corpus <- tm_map(corpus, content_transformer(sub), pattern = ".*?\n", replacement = "")
  corpus <- tm_map(corpus, stripWhitespace)
  corpus <- tm_map(corpus, content_transformer(iconv), to = "ASCII//TRANSLIT")
  corpus <- tm_map(corpus, content_transformer(gsub), pattern = "-", replacement = "-")
  corpus <- tm_map(corpus, content_transformer(gsub), pattern = "case is submitted.*", replacement = "case is submitted", ignore.case = TRUE)
  corpus <- tm_map(corpus, content_transformer(gsub),
                   pattern = "^(.*?)(CHIEF JUSTICE ROBERTS:|CHIEF JUSTICE REHNQUIST:)",
                   replacement = "\\2", ignore.case = TRUE)

  scotus <- data.frame(text = sapply(corpus, as.character), stringsAsFactors = FALSE) # Convert Corpus to Dataframe
  scotus$text <- iconv(scotus$text, to = "UTF-8")

  file_names_processed <- c()  # Initialize character vector for processed file names

  for (file_name in file_names) {
    file_names_processed <- c(file_names_processed, file_name)
  }

  # Process the file names at the end
  file_names_processed <- gsub("\\_.*", "", file_names_processed)
  file_names_processed <- gsub(".pdf", "", file_names_processed)
  file_names_processed <- data.frame(file_names_processed)
  names(file_names_processed)[1] <- "file_names"
  scotus$argument <- file_names_processed$file_names

  return(scotus)
}


```

```{r, eval = F}
#Load scotustext package
install.packages("scotustext")
library(scotustext)
```

## **Oral Argument Functions**

These tools aim to help with retrieving, processing, and cleaning oral argument transcripts from the United States Supreme Court.

Within the *Oral Arguments* suite of `library(scotustext)` are **two** primary tools:

-   `oa_search`: An automated tool for retrieving cleaned and partitioned transcripts (and relevant data) from orally argued cases at the United States Supreme Court between the **2004 and 2022 terms** (Updated June 2023). The dataset will be periodically updated throughout subsequent terms.
-   `oa_parser`: An automated tool for processing, cleaning, and parsing docket sheets from PDFs stored on your local machine.

**NOTE**: While `oa_parser` should work for any non-scanned PDF oral argument transcript, best use is found for transcripts between the 2004 and 2022 terms. The reason for this stems from the processing protocols in `oa_parser`, which relies on locating demarcations in transcripts based on unique justice and attorney-level identifiers. For example:

-   JUSTICE BREYER: \<**TRANSCIPT TEXT**\>
-   MR. KATYAL: \<**TRANSCIPT TEXT**\>

It is rare to find non-scanned PDFs of oral arguments, even those on supremecourt.gov that follow this pattern. Instead, most pre-2004 arguments followed a process of identifying changes in which justice(s) is engaging with:

-   QUESTION: \<**TRANSCIPT TEXT**\>

`oa_parser`is still capable of accurately locating these demarcations, but the ability to assess which justice is actually engaging with counsel is no longer possible.

## **oa_search()** Walkthrough

`oa_search` accepts several optional parameters to customize and curtail search queries:

-   `term`: Character (or vector of comma-separated character objects) containing relevant term(s) of interest\
    (e.g., "2022" or c("2022", "2005"))
-   `justice`: Character (or vector of comma-separated character objects) containing relevant justice(s) of interest\
    (e.g., "Breyer" or c("Breyer", "Alito", "Roberts"))
-   `attorney`: Character (or vector of comma-separated character objects) containing relevant attorneys(s) of interest\
    (e.g., "Katyal" or c("Katyal", "Francisco"))
-   `speaker_type`: Character object indicating "Justices" or "Attorneys" (Default is **BOTH**).
-   `docket_id`: Character (or vector of comma-separated character objects) containing relevant docket number assigned to argument(s) of interest\
    (e.g., "19-1392")
-   `party`: Character (or vector of comma-separated character objects) containing relevant party (or parties) of interest addressed in official case title.\
    (e.g., *Dobbs* or c(*Dobbs*, *Bruen*, *Citizens United*))

**NOTE**: Search queries limited to October Terms 2004 to 2022 (as of May 2023). Queries will return all matches to provided parameters. Not providing any parameters will retrieve *all* transcript data from OT04 to OT22.

### **oa_search()** Examples

Below is a collection of example code highlighting the functionality of `oa_search` and how optional parameters can curtail queries.

```{r, warning = F, include = F}
#Retrieve All Oral Argument Transcript Data (OT04 to OT22)
#Leave Optional Parameters Empty
oral_arguments <- oa_search()

#Variable Names
names(oral_arguments)

#Number of Entries for Justice Breyer
length(oral_arguments$text[oral_arguments$speaker == "JUSTICE BREYER"])

#Number of Entries for Paul Clement (Attorney and Fmr. Solicitor General)
length(oral_arguments$text[oral_arguments$speaker == "MR. CLEMENT"])

#Number of Unique Attorneys in Dataset
length(oral_arguments$text[oral_arguments$type == "Attorney"])

```

#### Curtailing Search Queries

**Retrieve Transcripts from OT2017**
```{r, warning = F}
oral_arguments_07 <- oa_search(term = "2017")

#Number of Entries Returned For OT2017
length(oral_arguments_07$text)
```

**Retrieve Transcripts Limited to Justice Breyer**
```{r, warning = F, message = F}
oral_arguments_breyer <- oa_search(justice = "Breyer")

#Number of Entries Returned For Breyer
length(oral_arguments_breyer$text)
```

**Retrieve Transcripts Limited to Justices Breyer and Ginsburg in OT2017 and OT2018**
```{r, warning = F, message = F}
oral_arguments_0718_breyer_ginsburg <- oa_search(term = c("2017", "2018"), justice = c("Breyer", "Ginsburg"))

#Number of Entries Returned For Breyer & Ginsburg in OT17 and OT18
length(oral_arguments_0718_breyer_ginsburg$text)
```

**Retrieve Transcripts from Dobbs v. Jackson**
```{r, warning = F, message = F}
oral_arguments_dobbs <- oa_search(party = "Dobbs")

#Number of Entries Returned For Dobbs
length(oral_arguments_dobbs$text)
```

**Sample Transcript Data from Dobbs v. Jackson**
```{r, echo = FALSE, warning = F, message = F}
formatted_text <- paste0(oral_arguments_dobbs$speaker, ": ", oral_arguments_dobbs$text)
head(formatted_text, 5)
```

### **oa_parser()** Walkthrough

Implementation of the `oa_parser` tool only requires a single parameter, `dir_path`, which provides a file path (as a character object) to the folder on your local machine containing oral argument transcript(s) saved as PDFs. As noted above, the most efficient use of the tool is found with transcripts following (and including) the 2004 term, which coincides with the Court prescribing demarcations to indicate which of the justices are engaging with counsel -- though it is capable of cleaning and parsing earlier pre-2004 transcripts where demarcations are indicated using "*QUESTION:...*".

It should also be noted that this tool does **not** employ the use of Optical Character Recognition (OCR) software. As such, the tool can only process **non-scanned** PDF transcripts.  

## **oa_parser()** Examples

Below is an example of two oral arguments from the 2022 term: 

-   *Twitter, Inc. v. Taamneh* (21-1496)
-   *Students for Fair Admissions v. University of North Carolina* (20-1199)

```{r, warning = F, eval = F}
#Replace <FOLDER DIRECTORY> with Relevant File Path
oa_parse_sample <- oa_parser(dir_path = <FOLDER DIRECTORY>)
```
```{r, echo = FALSE, warning = F, message = F, eval = T}
oa_parse_sample <- oa_parser(dir_path = "C:/Users/Jake Truscott/OneDrive - University of Georgia/Active/Justices Oral Argument Rhetoric/SCOTUS_Transcripts/sample_transcripts")
```
```{r, warning = F}
#Number of Entries Returned For Twitter, Inc & UNC
length(unique(oa_parse_sample$text))
```
**Sample Transcript Data from Students For Fair Admissions v. UNC**
```{r, echo = FALSE, warning = F, message = F}
formatted_text <- paste0(oa_parse_sample$speaker, ": ", oa_parse_sample$text)
head(formatted_text, 5)
```

